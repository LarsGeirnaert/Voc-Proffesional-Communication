<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOCAB MASTER: ULTIMATE</title>
    <link rel="stylesheet" href="style.css">
    <script src="vocab_data.js"></script> 
</head>
<body>
    <canvas id="confetti-canvas"></canvas>

    <div class="dashboard">
        <div class="cat-btn new" onclick="showList(0)">
            <span class="label">Niet Gekend</span>
            <span class="count" id="cnt-new">0</span>
        </div>
        <div class="cat-btn bad" onclick="showList(-1)">
            <span class="label">Slecht Gekend</span>
            <span class="count" id="cnt-bad">0</span>
        </div>
        <div class="cat-btn good" onclick="showList(1)">
            <span class="label">Goed Gekend</span>
            <span class="count" id="cnt-good">0</span>
        </div>
        <div class="cat-btn full" onclick="showList(2)">
            <span class="label">Volledig Gekend</span>
            <span class="count" id="cnt-full">0</span>
        </div>
        <div class="cat-btn starred" onclick="showList('star')">
            <span class="label">Ooit Moeilijk / Pass</span>
            <span class="count" id="cnt-star">‚òÖ 0</span>
        </div>
    </div>

    <div class="game-container" id="game-ui">
        <div class="progress-section">
            <div class="progress-label">
                <span>TOTALE PROGRESSIE</span>
                <span id="mastery-pct">0.00%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="mastery-bar"></div>
            </div>
        </div>

        <div class="hud">
            <span>Score: <span id="score">0</span></span>
            <span id="timer">25.0s</span>
        </div>
        
        <div class="timer-container" id="timer-container-div">
            <div class="timer-marker" title="Starttijd (25s)"></div>
            <div class="timer-fill" id="visual-timer"></div>
        </div>

        <div class="definition-box" id="definition-area">
            Klik op START om te beginnen.
        </div>

        <div class="input-group" id="input-area">
            <input type="text" id="answer-input" placeholder="..." disabled autocomplete="off">
        </div>

        <div class="controls" id="game-controls" style="display:none;">
            <button class="btn btn-pass" onclick="passWord()">PASS (Overslaan)</button>
            <button class="btn btn-stop" onclick="stopGame()">STOP & OPSLAAN</button>
        </div>

        <div class="fc-controls" id="fc-controls" style="display:none;">
             <button id="btn-show-answer" class="btn btn-show" onclick="revealFlashcard()">Toon Antwoord (Spatie)</button>
             
             <div id="fc-rating-btns" class="fc-rating-row" style="display:none;">
                 <button class="btn btn-fc-bad" onclick="handleFlashcardResult(false)">[1] ‚ùå Nog niet</button>
                 <button class="btn btn-fc-good" onclick="handleFlashcardResult(true)">[2] ‚úÖ Ik wist hem</button>
             </div>
        </div>

        <div class="controls" id="fc-stop-controls" style="display:none;">
             <button class="btn btn-stop" onclick="stopGame()">STOP</button>
             <div style="text-align:center; width:100%; font-size:0.8rem; color:#666; margin-top:5px;">
                Spatie = Toon | 1/Links = Fout | 2/Rechts = Goed
             </div>
        </div>
        
        <div class="settings-row" id="settings-div">
            <select id="mode-select" class="game-select" onchange="toggleSettingsUI()">
                <option value="overdrive">üöÄ Overdrive (Typen)</option>
                <option value="flashcards">üé¥ Flashcards</option>
            </select>

            <select id="unit-select" class="unit-select" onchange="saveUnitSelection()">
                <option value="all">Alle Units</option>
            </select>
            
            <label class="toggle-label" id="timer-toggle-label">
                <input type="checkbox" id="timer-check" checked>
                <span>Tijd</span>
            </label>

            <button class="btn-reset-unit" onclick="resetSpecificUnit()" title="Reset deze unit naar 0">
                ‚Ü∫ Reset
            </button>
        </div>
        
        <button class="btn btn-start" id="start-btn" onclick="startGame()">START GAME</button>
    </div>

    <div class="reset-container">
        <div class="reset-row">
            <button class="btn-reset data-btn" onclick="exportData()">üíæ Backup Opslaan</button>
            <button class="btn-reset data-btn" onclick="document.getElementById('import-file').click()">üìÇ Backup Laden</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)">
        </div>
        <div class="reset-row" style="margin-top:10px;">
            <button class="btn-reset neutral" onclick="resetSpecificUnit()">Reset Unit...</button>
            <button class="btn-reset star-reset" onclick="resetStarredToNew()">Reset ‚òÖ</button>
            <button class="btn-reset neutral" onclick="unstarAll()">Verwijder ‚òÖ</button>
        </div>
        <button class="btn-reset danger" onclick="resetProgress()">‚ö† RESET ALLES</button>
    </div>

    <div class="modal" id="list-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" style="margin:0;">Lijst</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="word-list" id="modal-list-body"></div>
        </div>
    </div>

<script>
    // --- 1. SETUP & DATA ---
    let progressMap = JSON.parse(localStorage.getItem('vocab_progress_v2')) || {};
    let starredMap = JSON.parse(localStorage.getItem('vocab_starred')) || {};
    
    let activeQueue = [];
    let currentItem = null;
    let lastWord = null; 
    let isReviewWord = false; 
    let score = 0;
    
    const START_TIME = 25.0; 
    const VISUAL_MAX_TIME = 60.0; 
    let timer = START_TIME; 
    let timerEnabled = true; 
    let currentMode = 'overdrive'; 
    
    // Flashcard specifieke state
    let isFlipped = false; 
    let isRevealed = false; // Is het antwoord zichtbaar?
    let isProcessing = false; // Voorkomt dubbelklik
    
    let gameInterval;
    let isPlaying = false;

    if (typeof vocabDatabase !== 'undefined') {
        let hasChanges = false;
        vocabDatabase.forEach(item => {
            const level = progressMap[item.w];
            if (level === -1 && !starredMap[item.w]) {
                starredMap[item.w] = true;
                hasChanges = true;
            }
        });
        if(hasChanges) localStorage.setItem('vocab_starred', JSON.stringify(starredMap));
        
        refreshStats();
        populateUnitDropdown(); 
    } else {
        document.getElementById('definition-area').innerText = "ERROR: vocab_data.js niet gevonden!";
        document.getElementById('definition-area').style.color = "red";
    }

    // --- KEYBOARD SHORTCUTS ---
        document.addEventListener('keydown', (e) => {
            // Check: Spel moet bezig zijn, Flashcard mode, en geen animatie bezig
            if (!isPlaying || currentMode !== 'flashcards' || isProcessing) return;

            // FASE 1: Kaart is nog dicht?
            // -> ELKE toets maakt hem open (Any key)
            if (!isRevealed) {
                e.preventDefault(); // Voorkomt scrollen als je bijv. pijltje omlaag drukt
                revealFlashcard();
                return; // Stop hier, zodat je niet per ongeluk meteen ook een score indrukt
            }

            // FASE 2: Kaart is open?
            // -> Nu luisteren we pas naar specifiek 1/Links of 2/Rechts
            if (e.key === '1' || e.key === 'ArrowLeft') handleFlashcardResult(false);
            if (e.key === '2' || e.key === 'ArrowRight') handleFlashcardResult(true);
        });

    // --- UI FUNCTIES ---
    function toggleSettingsUI() {
        const mode = document.getElementById('mode-select').value;
        const timerLabel = document.getElementById('timer-toggle-label');
        if (mode === 'flashcards') timerLabel.style.display = 'none';
        else timerLabel.style.display = 'flex';
    }

    function populateUnitDropdown() {
        const select = document.getElementById('unit-select');
        select.innerHTML = '<option value="all">Alle Units</option>';
        const uniqueUnits = [...new Set(vocabDatabase.map(item => item.u))].sort((a,b)=>a-b);

        uniqueUnits.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            const unitWords = vocabDatabase.filter(w => w.u === unit);
            const total = unitWords.length;
            const mastered = unitWords.filter(w => (progressMap[w.w] || 0) === 2).length;
            if (total > 0 && total === mastered) {
                option.innerText = `Unit ${unit} (VOLTOOID)`;
                option.disabled = true; 
            } else {
                option.innerText = `Unit ${unit}`;
            }
            select.appendChild(option);
        });
        const savedUnit = localStorage.getItem('vocab_last_unit');
        if (savedUnit) {
            const opt = select.querySelector(`option[value="${savedUnit}"]`);
            if (opt && !opt.disabled) select.value = savedUnit;
        }
    }
    function saveUnitSelection() { localStorage.setItem('vocab_last_unit', document.getElementById('unit-select').value); }

    function resetSpecificUnit() {
        const unitInput = prompt("Welke Unit resetten? (Typ nummer)");
        if (!unitInput) return;
        const targetUnit = parseInt(unitInput);
        const validUnits = [...new Set(vocabDatabase.map(i => i.u))];
        if (!validUnits.includes(targetUnit)) { alert("Ongeldige Unit."); return; }
        if(confirm(`Unit ${targetUnit} resetten?`)) {
            vocabDatabase.forEach(item => { if (item.u === targetUnit) progressMap[item.w] = 0; });
            saveProgress(); populateUnitDropdown(); 
            alert(`Unit ${targetUnit} is gereset.`);
        }
    }

    // --- BACKUP ---
    function exportData() {
        const data = { progress: progressMap, starred: starredMap, date: new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "vocab_save.json";
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
    function importData(input) {
        const file = input.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data.progress && data.starred) {
                    progressMap = data.progress; starredMap = data.starred;
                    saveProgress(); alert("Backup succesvol ingeladen!"); location.reload();
                } else alert("Ongeldig bestand.");
            } catch (err) { alert("Fout bij lezen bestand."); }
        }; reader.readAsText(file);
    }

    // --- 2. GAME LOGIC ---

    function startGame() {
        buildQueue();
        if(activeQueue.length === 0) { alert("Deze selectie is al volledig gekend!"); return; }

        currentMode = document.getElementById('mode-select').value;
        timerEnabled = document.getElementById('timer-check').checked;
        lastWord = null; score = 0; timer = START_TIME;
        isPlaying = true; isProcessing = false; isRevealed = false;
        document.getElementById('score').innerText = score;

        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('settings-div').style.display = 'none'; 
        
        if (currentMode === 'flashcards') {
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('fc-controls').style.display = 'flex'; // Toon container
            document.getElementById('fc-stop-controls').style.display = 'block'; 
            document.getElementById('timer-container-div').style.display = 'none';
            document.getElementById('timer').style.opacity = '0'; 
        } else {
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('game-controls').style.display = 'flex';
            document.getElementById('fc-controls').style.display = 'none';
            document.getElementById('fc-stop-controls').style.display = 'none';
            document.getElementById('timer-container-div').style.display = 'block';
            document.getElementById('timer').style.opacity = '1';
            const input = document.getElementById('answer-input');
            input.disabled = false; input.value = ""; input.focus();
            if (!timerEnabled) {
                document.getElementById('timer').innerText = "‚àû";
                document.getElementById('timer').style.color = "var(--accent)";
                document.getElementById('visual-timer').style.width = "100%";
                document.getElementById('visual-timer').className = "timer-fill safe";
            }
        }
        nextWord();
        if (currentMode !== 'flashcards') gameInterval = setInterval(gameLoop, 100);
    }

    function buildQueue() {
        const selectedUnit = document.getElementById('unit-select').value;
        activeQueue = vocabDatabase.filter(item => {
            const level = progressMap[item.w] || 0;
            const notMastered = level < 2;
            const unitMatch = (selectedUnit === 'all') || (item.u.toString() === selectedUnit);
            return notMastered && unitMatch;
        });
    }

    function gameLoop() {
        if (!isPlaying) return;
        if (timerEnabled) {
            timer -= 0.1;
            const timerEl = document.getElementById('timer');
            timerEl.innerText = timer.toFixed(1) + 's';
            const bar = document.getElementById('visual-timer');
            let pct = (timer / VISUAL_MAX_TIME) * 100;
            if (pct > 100) pct = 100; if (pct < 0) pct = 0;
            bar.style.width = pct + "%";
            bar.className = "timer-fill"; timerEl.style.color = "var(--accent)"; 
            if (timer <= 10) { bar.classList.add('danger'); timerEl.style.color = "var(--c-bad)"; } 
            else if (timer >= 50) { bar.classList.add('max'); timerEl.style.color = "var(--max)"; } 
            else if (timer > 30) { bar.classList.add('overdrive'); timerEl.style.color = "var(--overdrive)"; } 
            else { bar.classList.add('safe'); }
            if (timer <= 0) gameOver();
        }
    }

    function nextWord() {
        if (activeQueue.length === 0) { endGameVictory(); return; }

        let totalMastered = 0;
        vocabDatabase.forEach(i => { if((progressMap[i.w]||0)===2) totalMastered++; });
        const masteryRatio = totalMastered / vocabDatabase.length;
        isReviewWord = false; 

        if (masteryRatio > 0.5 && Math.random() < 0.05) {
            const masteredPool = vocabDatabase.filter(i => (progressMap[i.w]||0)===2);
            if (masteredPool.length > 0) {
                currentItem = masteredPool[Math.floor(Math.random() * masteredPool.length)];
                isReviewWord = true; 
            }
        }
        if (!isReviewWord) {
            let candidates = [...activeQueue];
            if (candidates.length > 1 && lastWord) candidates = candidates.filter(w => w.w !== lastWord.w);
            currentItem = candidates[Math.floor(Math.random() * candidates.length)];
        }
        lastWord = currentItem; 
        
        // Reset Flashcard State voor nieuw woord
        isRevealed = false;
        
        // UI Resetten
        document.getElementById('btn-show-answer').style.display = 'block';
        document.getElementById('fc-rating-btns').style.display = 'none';

        renderGameUI();
    }

    function renderGameUI() {
        const area = document.getElementById('definition-area');
        area.classList.remove('fc-feedback-good', 'fc-feedback-bad');

        if (currentMode === 'flashcards') {
            isFlipped = false;
            // De kaart begint NIET geflipped
            area.innerHTML = `
                <div class="flashcard-content" onclick="if(!isRevealed) revealFlashcard()">
                    <div class="fc-face fc-front">${currentItem.d}</div>
                    <div class="fc-face fc-back">${currentItem.w}</div>
                </div>
            `;
        } else {
            area.innerHTML = currentItem.d;
            document.getElementById('answer-input').value = "";
        }
    }

    // --- NIEUWE FUNCTIE: REVEAL ---
    function revealFlashcard() {
        if (!isPlaying || isRevealed) return;
        
        // Flip de kaart
        const card = document.querySelector('.flashcard-content');
        if (card) card.classList.add('flipped');
        
        // Update UI Knoppen
        document.getElementById('btn-show-answer').style.display = 'none';
        document.getElementById('fc-rating-btns').style.display = 'flex';
        
        isRevealed = true;
    }

    document.getElementById('answer-input').addEventListener('input', (e) => {
        if (!isPlaying || currentMode === 'flashcards') return;
        const val = e.target.value.trim().toLowerCase();
        const correct = currentItem.w.toLowerCase();
        if (val === correct) handleCorrect();
    });

    window.handleFlashcardResult = function(success) {
        if (!isPlaying || isProcessing) return;
        isProcessing = true; // Lock

        // Visuele feedback op de rand
        const area = document.getElementById('definition-area');
        if (success) area.classList.add('fc-feedback-good');
        else area.classList.add('fc-feedback-bad');

        // Even wachten zodat gebruiker de rand ziet, dan next
        setTimeout(() => {
            if (success) handleCorrect(true);
            else passWord(true);
            isProcessing = false; // Unlock
        }, 500); // 0.5s is genoeg voor confirmatie
    }

    function handleCorrect(skipVisuals = false) {
        if (currentMode !== 'flashcards' && !skipVisuals) {
            const inputEl = document.getElementById('answer-input');
            inputEl.classList.add('flash-green');
            setTimeout(() => inputEl.classList.remove('flash-green'), 300);
        }

        if (!isReviewWord) {
            let lvl = progressMap[currentItem.w] || 0;
            lvl = (lvl===-1)?1:(lvl===0)?1:2;
            progressMap[currentItem.w] = lvl; 
            if (lvl === 2) {
                checkUnitCompletion(currentItem.u);
                activeQueue = activeQueue.filter(i=>i.w!==currentItem.w);
            }
            saveProgress();
        }

        if (timerEnabled && currentMode !== 'flashcards') {
            timer = Math.min(timer + 10, VISUAL_MAX_TIME);
        }
        score++;
        document.getElementById('score').innerText = score;
        nextWord();
    }
    
    function checkUnitCompletion(unitId) {
        const unitWords = vocabDatabase.filter(w => w.u === unitId);
        const total = unitWords.length;
        const mastered = unitWords.filter(w => (progressMap[w.w] || 0) === 2).length;
        if (total > 0 && total === mastered) fireConfetti();
    }

    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];
        const colors = ['#eab308', '#22c55e', '#3b82f6', '#ef4444', '#a855f7'];
        for(let i=0; i<150; i++) {
            particles.push({
                x: window.innerWidth / 2, y: window.innerHeight / 2,
                w: Math.random() * 10 + 5, h: Math.random() * 10 + 5,
                vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20 - 5,
                color: colors[Math.floor(Math.random() * colors.length)], grav: 0.1, drag: 0.96
            });
        }
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            let active = false;
            particles.forEach(p => {
                p.x += p.vx; p.y += p.vy; p.vy += p.grav; p.vx *= p.drag; p.vy *= p.drag;
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.w, p.h);
                if (p.y < canvas.height) active = true;
            });
            if(active) requestAnimationFrame(animate); else ctx.clearRect(0,0,canvas.width,canvas.height);
        }
        animate();
    }

    function passWord(skipVisuals = false) {
        if (!isPlaying) return;
        if (timerEnabled && currentMode !== 'flashcards') timer -= 3;

        if (currentMode !== 'flashcards' && !skipVisuals) {
            const inputEl = document.getElementById('answer-input');
            inputEl.classList.add('flash-red');
            inputEl.value = "Antwoord: " + currentItem.w; 
            setTimeout(() => {
                inputEl.classList.remove('flash-red');
                nextWord();
            }, 1000);
            return; 
        } 
        
        if (isReviewWord) {
            progressMap[currentItem.w] = 1; 
            activeQueue.push(currentItem);
            alert("Oei! Degradeerd naar 'Goed Gekend'.");
        } else {
            progressMap[currentItem.w] = -1;
            starredMap[currentItem.w] = true;
        }
        localStorage.setItem('vocab_starred', JSON.stringify(starredMap));
        saveProgress(); refreshStats();
        
        if (currentMode === 'flashcards' || skipVisuals) {
            nextWord();
        }
    }

    function stopGame() {
        if (!isPlaying) return;
        isPlaying = false; clearInterval(gameInterval);
        alert(`Gestopt. Score: ${score}`); location.reload();
    }
    function gameOver() {
        isPlaying = false; clearInterval(gameInterval);
        alert(`GAME OVER! Score: ${score}. Woord was: ${currentItem.w}`); location.reload();
    }
    function endGameVictory() {
        isPlaying = false; clearInterval(gameInterval);
        alert("GEWELDIG! Alles gekend in deze set!"); location.reload();
    }

    function saveProgress() { localStorage.setItem('vocab_progress_v2', JSON.stringify(progressMap)); refreshStats(); }
    function refreshStats() {
        let counts = { "-1": 0, "0": 0, "1": 0, "2": 0 };
        let starCount = 0;
        vocabDatabase.forEach(item => {
            let lvl = progressMap[item.w];
            if (lvl === undefined) lvl = 0;
            counts[lvl]++;
            if(starredMap[item.w]) starCount++;
        });
        document.getElementById('cnt-new').innerText = counts[0];
        document.getElementById('cnt-bad').innerText = counts[-1];
        document.getElementById('cnt-good').innerText = counts[1];
        document.getElementById('cnt-full').innerText = counts[2];
        document.getElementById('cnt-star').innerText = "‚òÖ " + starCount;
        const max = vocabDatabase.length * 3;
        let pts = (counts[-1]*1) + (counts[1]*2) + (counts[2]*3);
        const pct = max > 0 ? ((pts / max) * 100).toFixed(2) : "0.00";
        document.getElementById('mastery-bar').style.width = pct + "%";
        document.getElementById('mastery-pct').innerText = pct + "%";
    }

    function resetProgress() { if(confirm("Alles wissen?")) { localStorage.clear(); location.reload(); }}
    function resetStarredToNew() { const k = Object.keys(starredMap); if(k.length && confirm("Reset ‚òÖ?")) { k.forEach(w=>progressMap[w]=0); saveProgress(); alert("Klaar");}}
    function unstarAll() { if(confirm("Verwijder ‚òÖ?")) { starredMap={}; localStorage.removeItem('vocab_starred'); refreshStats();}}
    function showList(type) {
        const modal = document.getElementById('list-modal'), body = document.getElementById('modal-list-body');
        const title = document.getElementById('modal-title');
        let words = [], label="", color="";
        if (type === 'star') { label="Gemarkeerd"; color="var(--c-star)"; words=vocabDatabase.filter(i=>starredMap[i.w]); }
        else {
            const l={0:"Niet Gekend","-1":"Slecht",1:"Goed",2:"Volledig"}, c={0:"var(--c-new)","-1":"var(--c-bad)",1:"var(--c-good)",2:"var(--c-full)"};
            label=l[type]; color=c[type]; words=vocabDatabase.filter(i=>(progressMap[i.w]||0)===type);
        }
        title.innerText = label; title.style.color = color; body.innerHTML = "";
        if(!words.length) body.innerHTML = "<div style='padding:20px;text-align:center'>Leeg</div>";
        else words.forEach(i => {
            const s = starredMap[i.w]?'star-active':'star-inactive';
            const d = document.createElement('div'); d.className='list-item';
            d.innerHTML = `<div style="flex:1"><strong>${i.w}</strong> (U${i.u})</div><div class="star-toggle ${s}" onclick="toggleStar('${i.w.replace(/'/g, "\\'")}')">‚òÖ</div>`;
            body.appendChild(d);
        });
        modal.style.display = 'flex';
    }
    function toggleStar(w) { if(starredMap[w]) delete starredMap[w]; else starredMap[w]=true; localStorage.setItem('vocab_starred', JSON.stringify(starredMap)); refreshStats(); closeModal(); }
    function closeModal() { document.getElementById('list-modal').style.display = 'none'; }
    window.onclick = e => { if(e.target == document.getElementById('list-modal')) closeModal(); }
</script>
</body>
</html>