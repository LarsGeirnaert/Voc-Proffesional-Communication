<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOCAB MASTER: DUO MODE</title>
    <link rel="stylesheet" href="style.css">
    <script src="vocab_data.js"></script> 
</head>
<body>

    <div class="dashboard">
        <div class="cat-btn new" onclick="showList(0)">
            <span class="label">Niet Gekend</span>
            <span class="count" id="cnt-new">0</span>
        </div>
        <div class="cat-btn bad" onclick="showList(-1)">
            <span class="label">Slecht Gekend</span>
            <span class="count" id="cnt-bad">0</span>
        </div>
        <div class="cat-btn good" onclick="showList(1)">
            <span class="label">Goed Gekend</span>
            <span class="count" id="cnt-good">0</span>
        </div>
        <div class="cat-btn full" onclick="showList(2)">
            <span class="label">Volledig Gekend</span>
            <span class="count" id="cnt-full">0</span>
        </div>
        <div class="cat-btn starred" onclick="showList('star')">
            <span class="label">Ooit Moeilijk / Pass</span>
            <span class="count" id="cnt-star">‚òÖ 0</span>
        </div>
    </div>

    <div class="game-container" id="game-ui">
        
        <div class="progress-section">
            <div class="progress-label">
                <span>TOTALE PROGRESSIE</span>
                <span id="mastery-pct">0.00%</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="mastery-bar"></div>
            </div>
        </div>

        <div class="hud">
            <span>Score: <span id="score">0</span></span>
            <span id="timer">25.0s</span>
        </div>
        
        <div class="timer-container" id="timer-container-div">
            <div class="timer-marker" title="Starttijd (25s)"></div>
            <div class="timer-fill" id="visual-timer"></div>
        </div>

        <div class="definition-box" id="definition-area">
            Klik op START om te beginnen.
        </div>

        <div class="input-group" id="input-area">
            <input type="text" id="answer-input" placeholder="..." disabled autocomplete="off">
        </div>

        <div class="controls" id="game-controls" style="display:none;">
            <button class="btn btn-pass" onclick="passWord()">PASS (Overslaan)</button>
            <button class="btn btn-stop" onclick="stopGame()">STOP & OPSLAAN</button>
        </div>

        <div class="fc-controls" id="fc-controls" style="display:none;">
             <button class="btn btn-fc-bad" onclick="handleFlashcardResult(false)">‚ùå Nog niet</button>
             <button class="btn btn-fc-good" onclick="handleFlashcardResult(true)">‚úÖ Ik wist hem</button>
        </div>
        <div class="controls" id="fc-stop-controls" style="display:none;">
             <button class="btn btn-stop" onclick="stopGame()">STOP</button>
        </div>
        
        <div class="settings-row" id="settings-div">
            <select id="mode-select" class="game-select" onchange="toggleSettingsUI()">
                <option value="overdrive">üöÄ Overdrive (Typen)</option>
                <option value="flashcards">üé¥ Flashcards</option>
            </select>

            <select id="unit-select" class="unit-select" onchange="saveUnitSelection()">
                <option value="all">Alle Units</option>
            </select>
            
            <label class="toggle-label" id="timer-toggle-label">
                <input type="checkbox" id="timer-check" checked>
                <span>Tijd</span>
            </label>

            <button class="btn-reset-unit" onclick="resetSpecificUnit()" title="Reset deze unit naar 0">
                ‚Ü∫ Reset
            </button>
        </div>
        
        <button class="btn btn-start" id="start-btn" onclick="startGame()">START GAME</button>
    </div>

    <div class="reset-container">
        <div class="reset-row">
            <button class="btn-reset neutral" onclick="resetSpecificUnit()">Reset Unit...</button>
            <button class="btn-reset star-reset" onclick="resetStarredToNew()">Reset ‚òÖ</button>
            <button class="btn-reset neutral" onclick="unstarAll()">Verwijder ‚òÖ</button>
        </div>
        <button class="btn-reset danger" onclick="resetProgress()">‚ö† RESET ALLES (Totaal)</button>
    </div>

    <div class="modal" id="list-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" style="margin:0;">Lijst</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="word-list" id="modal-list-body"></div>
        </div>
    </div>

<script>
    // --- 1. SETUP & DATA ---
    let progressMap = JSON.parse(localStorage.getItem('vocab_progress_v2')) || {};
    let starredMap = JSON.parse(localStorage.getItem('vocab_starred')) || {};
    
    let activeQueue = [];
    let currentItem = null;
    let lastWord = null; 
    let isReviewWord = false; 
    let score = 0;
    
    const START_TIME = 25.0; 
    const VISUAL_MAX_TIME = 60.0; 
    let timer = START_TIME; 
    let timerEnabled = true; 
    let currentMode = 'overdrive'; 
    let isFlipped = false; // Voor flashcards
    
    let gameInterval;
    let isPlaying = false;

    if (typeof vocabDatabase !== 'undefined') {
        let hasChanges = false;
        vocabDatabase.forEach(item => {
            const level = progressMap[item.w];
            if (level === -1 && !starredMap[item.w]) {
                starredMap[item.w] = true;
                hasChanges = true;
            }
        });
        if(hasChanges) localStorage.setItem('vocab_starred', JSON.stringify(starredMap));
        
        refreshStats();
        populateUnitDropdown(); 
    } else {
        document.getElementById('definition-area').innerText = "ERROR: vocab_data.js niet gevonden!";
        document.getElementById('definition-area').style.color = "red";
    }

    // --- UI FUNCTIES ---

    function toggleSettingsUI() {
        const mode = document.getElementById('mode-select').value;
        const timerLabel = document.getElementById('timer-toggle-label');
        if (mode === 'flashcards') {
            timerLabel.style.display = 'none';
        } else {
            timerLabel.style.display = 'flex';
        }
    }

    function populateUnitDropdown() {
        const select = document.getElementById('unit-select');
        select.innerHTML = '<option value="all">Alle Units</option>';
        const uniqueUnits = [...new Set(vocabDatabase.map(item => item.u))].sort((a,b)=>a-b);

        uniqueUnits.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit;
            const unitWords = vocabDatabase.filter(w => w.u === unit);
            const total = unitWords.length;
            const mastered = unitWords.filter(w => (progressMap[w.w] || 0) === 2).length;
            
            if (total > 0 && total === mastered) {
                option.innerText = `Unit ${unit} (VOLTOOID)`;
                option.disabled = true; 
            } else {
                option.innerText = `Unit ${unit}`;
            }
            select.appendChild(option);
        });

        const savedUnit = localStorage.getItem('vocab_last_unit');
        if (savedUnit) {
            const opt = select.querySelector(`option[value="${savedUnit}"]`);
            if (opt && !opt.disabled) select.value = savedUnit;
        }
    }

    function saveUnitSelection() {
        localStorage.setItem('vocab_last_unit', document.getElementById('unit-select').value);
    }

    function resetSpecificUnit() {
        const unitInput = prompt("Welke Unit wil je resetten? (Typ nummer)");
        if (!unitInput) return;
        const targetUnit = parseInt(unitInput);
        
        const validUnits = [...new Set(vocabDatabase.map(i => i.u))];
        if (!validUnits.includes(targetUnit)) { alert("Ongeldige Unit."); return; }

        if(confirm(`Unit ${targetUnit} resetten?`)) {
            vocabDatabase.forEach(item => {
                if (item.u === targetUnit) progressMap[item.w] = 0;
            });
            saveProgress(); populateUnitDropdown(); 
            alert(`Unit ${targetUnit} is gereset.`);
        }
    }

    // --- 2. GAME LOGIC ---

    function startGame() {
        buildQueue();
        if(activeQueue.length === 0) {
            alert("Deze selectie is al volledig gekend!"); return;
        }

        currentMode = document.getElementById('mode-select').value;
        timerEnabled = document.getElementById('timer-check').checked;
        lastWord = null; 
        score = 0;
        timer = START_TIME;
        isPlaying = true;
        document.getElementById('score').innerText = score;

        // UI Setup
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('settings-div').style.display = 'none'; 
        
        if (currentMode === 'flashcards') {
            document.getElementById('input-area').style.display = 'none';
            document.getElementById('game-controls').style.display = 'none';
            document.getElementById('fc-controls').style.display = 'flex';
            document.getElementById('fc-stop-controls').style.display = 'flex';
            document.getElementById('timer-container-div').style.display = 'none';
            document.getElementById('timer').style.opacity = '0'; 
        } else {
            // Overdrive (Typen)
            document.getElementById('input-area').style.display = 'block';
            document.getElementById('game-controls').style.display = 'flex';
            document.getElementById('fc-controls').style.display = 'none';
            document.getElementById('fc-stop-controls').style.display = 'none';
            document.getElementById('timer-container-div').style.display = 'block';
            document.getElementById('timer').style.opacity = '1';
            
            const input = document.getElementById('answer-input');
            input.disabled = false; input.value = ""; input.focus();
            
            if (!timerEnabled) {
                document.getElementById('timer').innerText = "‚àû";
                document.getElementById('timer').style.color = "var(--accent)";
                document.getElementById('visual-timer').style.width = "100%";
                document.getElementById('visual-timer').className = "timer-fill safe";
            }
        }

        nextWord();
        
        // Start timer alleen als niet flashcards en enabled
        if (currentMode !== 'flashcards') {
            gameInterval = setInterval(gameLoop, 100);
        }
    }

    function buildQueue() {
        const selectedUnit = document.getElementById('unit-select').value;
        activeQueue = vocabDatabase.filter(item => {
            const level = progressMap[item.w] || 0;
            const notMastered = level < 2;
            const unitMatch = (selectedUnit === 'all') || (item.u.toString() === selectedUnit);
            return notMastered && unitMatch;
        });
    }

    function gameLoop() {
        if (!isPlaying) return;
        if (timerEnabled) {
            timer -= 0.1;
            const timerEl = document.getElementById('timer');
            timerEl.innerText = timer.toFixed(1) + 's';
            
            const bar = document.getElementById('visual-timer');
            let pct = (timer / VISUAL_MAX_TIME) * 100;
            if (pct > 100) pct = 100; if (pct < 0) pct = 0;
            bar.style.width = pct + "%";
            bar.className = "timer-fill"; timerEl.style.color = "var(--accent)"; 

            if (timer <= 10) { bar.classList.add('danger'); timerEl.style.color = "var(--c-bad)"; } 
            else if (timer >= 50) { bar.classList.add('max'); timerEl.style.color = "var(--max)"; } 
            else if (timer > 30) { bar.classList.add('overdrive'); timerEl.style.color = "var(--overdrive)"; } 
            else { bar.classList.add('safe'); }

            if (timer <= 0) gameOver();
        }
    }

    function nextWord() {
        if (activeQueue.length === 0) { endGameVictory(); return; }

        // Review Logica (5%)
        let totalMastered = 0;
        vocabDatabase.forEach(i => { if((progressMap[i.w]||0)===2) totalMastered++; });
        const masteryRatio = totalMastered / vocabDatabase.length;
        isReviewWord = false; 

        if (masteryRatio > 0.5 && Math.random() < 0.05) {
            const masteredPool = vocabDatabase.filter(i => (progressMap[i.w]||0)===2);
            if (masteredPool.length > 0) {
                currentItem = masteredPool[Math.floor(Math.random() * masteredPool.length)];
                isReviewWord = true; 
            }
        }

        if (!isReviewWord) {
            let candidates = [...activeQueue];
            if (candidates.length > 1 && lastWord) candidates = candidates.filter(w => w.w !== lastWord.w);
            currentItem = candidates[Math.floor(Math.random() * candidates.length)];
        }
        lastWord = currentItem; 
        
        renderGameUI();
    }

    function renderGameUI() {
        const area = document.getElementById('definition-area');
        
        if (currentMode === 'flashcards') {
            isFlipped = false;
            // Bouw de 3D card structuur
            area.innerHTML = `
                <div class="flashcard-content" onclick="this.classList.toggle('flipped'); isFlipped = !isFlipped;">
                    <div class="fc-face fc-front">
                        ${currentItem.d}
                    </div>
                    <div class="fc-face fc-back">
                        ${currentItem.w}
                    </div>
                </div>
            `;
        } else {
            // Overdrive (Standaard)
            area.innerHTML = currentItem.d;
            document.getElementById('answer-input').value = "";
        }
    }

    // --- INPUT HANDLING (Overdrive) ---
    document.getElementById('answer-input').addEventListener('input', (e) => {
        if (!isPlaying) return;
        if (currentMode === 'flashcards') return;
        
        const val = e.target.value.trim().toLowerCase();
        const correct = currentItem.w.toLowerCase();
        if (val === correct) handleCorrect();
    });

    // --- FLASHCARD HANDLING ---
    window.handleFlashcardResult = function(success) {
        if (!isPlaying) return;
        if (success) {
            handleCorrect(); 
        } else {
            passWord(); 
        }
    }

    function handleCorrect() {
        // Flash visual
        if (currentMode !== 'flashcards') {
            const inputEl = document.getElementById('answer-input');
            inputEl.classList.add('flash-green');
            setTimeout(() => inputEl.classList.remove('flash-green'), 300);
        } else {
            document.getElementById('definition-area').style.borderColor = "var(--c-full)";
            setTimeout(() => document.getElementById('definition-area').style.borderColor = "", 300);
        }

        if (!isReviewWord) {
            let lvl = progressMap[currentItem.w] || 0;
            lvl = (lvl===-1)?1:(lvl===0)?1:2;
            progressMap[currentItem.w] = lvl; 
            saveProgress();
            if(lvl===2) activeQueue = activeQueue.filter(i=>i.w!==currentItem.w);
        }

        if (timerEnabled && currentMode !== 'flashcards') {
            timer = Math.min(timer + 10, VISUAL_MAX_TIME);
        }
        
        score++;
        document.getElementById('score').innerText = score;
        nextWord();
    }

    function passWord() {
        if (!isPlaying) return;
        if (timerEnabled && currentMode !== 'flashcards') timer -= 3;

        // Visual Feedback
        if (currentMode !== 'flashcards') {
            const inputEl = document.getElementById('answer-input');
            inputEl.classList.add('flash-red');
            inputEl.value = "Antwoord: " + currentItem.w; 
            setTimeout(() => {
                inputEl.classList.remove('flash-red');
                nextWord();
            }, 1000);
        } else {
             document.getElementById('definition-area').style.borderColor = "var(--c-bad)";
             setTimeout(() => {
                 document.getElementById('definition-area').style.borderColor = "";
                 nextWord();
             }, 500);
        }
        
        if (isReviewWord) {
            progressMap[currentItem.w] = 1; 
            activeQueue.push(currentItem);
            alert("Oei! Degradeerd naar 'Goed Gekend'.");
        } else {
            progressMap[currentItem.w] = -1;
            starredMap[currentItem.w] = true;
        }
        
        localStorage.setItem('vocab_starred', JSON.stringify(starredMap));
        saveProgress();
        refreshStats();
    }

    function stopGame() {
        if (!isPlaying) return;
        isPlaying = false;
        clearInterval(gameInterval);
        alert(`Gestopt. Score: ${score}`);
        location.reload();
    }

    function gameOver() {
        isPlaying = false;
        clearInterval(gameInterval);
        alert(`GAME OVER! Score: ${score}. Woord was: ${currentItem.w}`);
        location.reload();
    }

    function endGameVictory() {
        isPlaying = false;
        clearInterval(gameInterval);
        alert("GEWELDIG! Alles gekend in deze set!");
        location.reload();
    }

    // --- 3. STORAGE & STATS ---

    function saveProgress() {
        localStorage.setItem('vocab_progress_v2', JSON.stringify(progressMap));
        refreshStats();
    }

    function refreshStats() {
        let counts = { "-1": 0, "0": 0, "1": 0, "2": 0 };
        let starCount = 0;
        
        vocabDatabase.forEach(item => {
            let lvl = progressMap[item.w];
            if (lvl === undefined) lvl = 0;
            counts[lvl]++;
            if(starredMap[item.w]) starCount++;
        });

        document.getElementById('cnt-new').innerText = counts[0];
        document.getElementById('cnt-bad').innerText = counts[-1];
        document.getElementById('cnt-good').innerText = counts[1];
        document.getElementById('cnt-full').innerText = counts[2];
        document.getElementById('cnt-star').innerText = "‚òÖ " + starCount;

        const maxPossiblePoints = vocabDatabase.length * 3;
        let currentPoints = (counts[-1]*1) + (counts[1]*2) + (counts[2]*3);
        const pct = maxPossiblePoints > 0 ? ((currentPoints / maxPossiblePoints) * 100).toFixed(2) : "0.00";
        
        document.getElementById('mastery-bar').style.width = pct + "%";
        document.getElementById('mastery-pct').innerText = pct + "%";
    }

    function resetProgress() {
        if(confirm("Alles wissen?")) {
            localStorage.clear(); location.reload();
        }
    }
    function resetStarredToNew() {
        const keys = Object.keys(starredMap);
        if (keys.length === 0) return;
        if(confirm("Reset ‚òÖ woorden?")) {
            keys.forEach(w => progressMap[w] = 0);
            saveProgress(); alert("Klaar.");
        }
    }
    function unstarAll() {
        if(confirm("Verwijder alle ‚òÖ?")) {
            starredMap = {}; localStorage.removeItem('vocab_starred'); refreshStats();
        }
    }

    // --- 4. LIST MODAL ---
    function showList(type) {
        const modal = document.getElementById('list-modal'), body = document.getElementById('modal-list-body');
        const title = document.getElementById('modal-title');
        
        let words = []; let label = ""; let color = "";
        
        if (type === 'star') {
            label = "Gemarkeerd"; color = "var(--c-star)";
            words = vocabDatabase.filter(i => starredMap[i.w]);
        } else {
            const labels = {0:"Niet Gekend", "-1":"Slecht", 1:"Goed", 2:"Volledig"};
            const colors = {0:"var(--c-new)", "-1":"var(--c-bad)", 1:"var(--c-good)", 2:"var(--c-full)"};
            label = labels[type]; color = colors[type];
            words = vocabDatabase.filter(i => (progressMap[i.w]||0)===type);
        }

        title.innerText = label; title.style.color = color; body.innerHTML = "";
        if(words.length===0) body.innerHTML = "<div style='padding:20px;text-align:center'>Leeg</div>";
        else {
            words.forEach(i => {
                const isStar = starredMap[i.w]?'star-active':'star-inactive';
                const div = document.createElement('div'); div.className='list-item';
                div.innerHTML = `<div style="flex:1"><strong>${i.w}</strong> (U${i.u})</div><div class="star-toggle ${isStar}" onclick="toggleStar('${i.w.replace(/'/g, "\\'")}')">‚òÖ</div>`;
                body.appendChild(div);
            });
        }
        modal.style.display = 'flex';
    }

    function toggleStar(w) {
        if(starredMap[w]) delete starredMap[w]; else starredMap[w]=true;
        localStorage.setItem('vocab_starred', JSON.stringify(starredMap));
        refreshStats(); closeModal();
    }
    function closeModal() { document.getElementById('list-modal').style.display = 'none'; }
    window.onclick = e => { if(e.target == document.getElementById('list-modal')) closeModal(); }

</script>
</body>
</html>